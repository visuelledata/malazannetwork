---
title: "eda"
author: "Chris Peralta"
date: "January 31, 2019"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tidytext)
source("R/import_books.R")
source("R/import_characters.R")
source("R/import_alias.R")
source("R/standardize_names.R")
#english_words <- read_csv("data/words_alpha.txt")
#places <- read_csv("data/places.txt")
```

Find more names:
Getting variations of names and combining lists. 
```{r}
names_and_aliases <- characters %>% 
  select(name) %>% 
  bind_rows(rename(select(alias, aliases), name = aliases)) %>% 
  distinct()

#The removed code below is unnecessary and wastes time
get_name_variations <- function(name_data){
  name_data <- name_data %>% 
    mutate(name = str_trim(name), 
           name = str_squish(name))
  
  # plural <- name_data %>% 
  #   mutate(name = paste0(name, "s"))
  # 
  # possessive <- name_data %>% 
  #   mutate(name = paste0(name, "'s"))
  # 
  # possessive_s <- name_data %>% 
  #   mutate(name = paste0(name, "'"))
   
  short_name <- name_data %>% 
    mutate(name = str_split(name, " ")) %>% 
    unnest() %>% 
    anti_join(stop_words, by = c("name" = "word")) %>% 
    anti_join(mutate(stop_words, word = str_to_title(word)), by = c("name" = "word"))
  
  # short_name_plural <- short_name %>% 
  #   mutate(name = paste0(name, "s"))
  # 
  # short_name_possessive <- short_name %>% 
  #   mutate(name = paste0(name, "'s"))
  # 
  # short_name_possessive_s <- short_name %>% 
  #   mutate(name = paste0(name, "'"))
    
  bind_rows(name_data, short_name) %>% 
            #plural, possessive, possessive_s, short_name_plural,
            #short_name_possessive, short_name_possessive_s) %>% 
    distinct()
}
```

Co-occurences: 
Use ngrams
Compare all of them against name variations
Remove all rows without names
Shrink everything horizontally
(at this point there is a dataframe of names)
Can make a network graph at this point
Remove duplicate names within each rows and names that match themselves

Co-occurences through ngrams with / without dialogue 
This is a minimal working example
```{r}
all_names <- get_name_variations(names_and_aliases) %>% 
  mutate(name = str_remove(name, "^The ")) %>% 
  filter(!str_detect(name, "^.{1,3}$")) %>%
  filter(name != "", name != "Doubt", name != "Imperial", name != "House", 
         name != "Wait", name != "Lying", name != "Felis", name != "Seventh", 
         name != "Twelfth", name != "Dead", name != "Jaghut", name != "Darkness",
         name != "Ghost", name != "Mortal", name != "Sword", name != "Shield", 
         name != "Anvil", name != "Master", name != "Deck", name != "Cold", 
         name != "Moon", name != "Mage", name != "Iron", name != "Soon", 
         name != "Throw", name != "Fire", name != "Lady", name != "Mage", 
         name != "Seer", name != "Lieutenant", name != "Breath", name != "Sort",
         name != "Pale", name != "Councilman", name != "Sergeant", name != "High Fist",
         name != "Elder", name != "Green", name != "Pig", name != "Hound", 
         name != "Shadow", name != "Queen", name != "Dark", name != "Whirlwind", 
         name != "Dryjhna", name != "Black", name != "Captain", name != "High", 
         name != "Fist", name != "Assassin", name != "Last", name != "Bear", 
         name != "One", name != "King", name != "Silent", name != "Esta", 
         name != "Lord", name != "D'Arle", name != "Life", name != "Will", 
         name != "White", name != "Artist", name != "Treat", name != "Cook", 
         name != "Fish", name != "Setral", name != "Crippled", name != "Claw", 
         name != "Grin", name != "Witch", name != "Ceda", name != "Light", 
         name != "Warleader", name != "Warlock", name != "Bone", name != "Sengar", 
         name != "Grey", name != "Sister", name != "Corporal", name != "Dying", 
         name != "Commander",
         !str_detect(name, "^[a-z]")) %>% 
  arrange(desc(nchar(name))) %>% 
  pull(name)

temp0 <- books %>% 
  standardize_names_book() %>% 
  group_by(book, chapter) %>% 
  unnest_tokens(ngram, line, token = "ngrams", n = 20, to_lower = FALSE) %>%
  nest() %>% 
  ungroup() 

pull_book_data <- function(book_data, i){
  book_data %>% 
    filter(book == i) %>% 
    pull(data)
}
book1 <- pull_book_data(temp0, 1)
book2 <- pull_book_data(temp0, 2)
book3 <- pull_book_data(temp0, 3)
book4 <- pull_book_data(temp0, 4)
book5 <- pull_book_data(temp0, 5)
book6 <- pull_book_data(temp0, 6)
book7 <- pull_book_data(temp0, 7)
book8 <- pull_book_data(temp0, 8)
book9 <- pull_book_data(temp0, 9)
book10 <- pull_book_data(temp0, 10)

library(future.apply)
```

```{r}
process_data <- function(datastuff, book_num, i){
tictoc::tic()
plan(multiprocess, workers = 4) 

placeholder <- datastuff %>% #Change Here####
  future_apply(1, function(x){
    map_chr(all_names,
            function(pat){
              name <- str_extract(x, pattern = fixed(pat))
              if(!is.na(name)) x <<- str_remove(x, pattern = fixed(pat))
              name
            })
  }, 
  future.seed = TRUE)

placeholder %>% 
  t() %>% 
  as.tibble() %>% 
  unite("names", V1:V3080, sep = ";") %>% 
  remove_NAs() %>% 
  mutate(book = book_num, 
         chapter = i) %>%  #Change Here####
  write_rds(paste0("data/network_data/network_data", 
                   book_num, "-", i,   #Change Here####
                   ".rds"), compress = "none")

tictoc::toc()
}

for (i in seq_along(book1)){
  process_data(book1[[i]], 1, i)
}

for (i in seq_along(book2)){
  process_data(book2[[i]], 2, i)
}

for (i in seq_along(book3)){
  process_data(book3[[i]], 3, i)
}

for (i in seq_along(book4)){
  process_data(book4[[i]], 4, i)
}

for (i in seq_along(book5)){
  process_data(book5[[i]], 5, i)
}

for (i in seq_along(book6)){
  process_data(book6[[i]], 6, i)
}

for (i in seq_along(book7)){
  process_data(book7[[i]], 7, i)
}

for (i in seq_along(book8)){
  process_data(book8[[i]], 8, i)
}

for (i in seq_along(book9)){
  process_data(book9[[i]], 9, i)
}

for (i in seq_along(book10)){
  process_data(book10[[i]], 10, i)
}
```

Clean and merge the data
Reduce duplicates (janitor::get_dupes)
Run standardize_names_net and update it
Write dataset to file
Analyze here / Gephi?
Animations starting with Paran in book 1 and add points with gganimate and tweenr?
Write docs

```{r}
network_data <- list.files("data/network_data") %>% 
  map_df(~read_rds(paste0("data/network_data/", .))) %>% 
  remove_NAs() %>% 
  filter(names != "", 
         str_detect(names, ";")) %>%
  standardize_names_net() %>% 
  distinct(names, book, chapter) 
#Start at n=188 with Gran who is a character in book 3
         
network_data %>% mutate(names = str_split(names, ";")) %>% unnest() %>% count(names) %>% arrange(desc(n)) %>% View

network_data <- network_data %>% 
  separate(names, into = paste0("name", 1:30), sep = ";")


library(ggraph)
library(tidygraph)

as_tbl_graph(network_data) %>% 
  activate(nodes) %>% 
  mutate(popularity = centrality_degree()) %>% 
  activate(nodes) %>% 
  filter(popularity > 10) %>%
  activate(nodes) %>% 
  filter(!node_is_isolated()) %>% 
  ggraph(layout = "nicely") + 
  geom_edge_link() + 
  geom_node_point(aes(size = popularity)) + 
  geom_node_text(aes(label = name, #alpha = (name %in% important_labels)), 
                 repel = TRUE, segment.size = 1, 
                 segment.color = "pink", color = "blue")) + 
  theme_void() + 
  theme(legend.position="none")


# important_labels <- temp1 %>% 
#   mutate(names = str_replace_all(names, "NA", "-"), 
#          names = str_replace_all(names, "-+", ","), 
#          names = str_remove_all(names, "^,|,$"),
#          names = str_split(names, ","),
#          connections = lengths(names)) %>% 
#   filter(connections > 9) %>% 
#   unnest() %>% 
#   pull(names) %>% 
#   unique()
# 
# tempgraph <- temp2 %>% 
#   filter(connections > 1) %>% 
#   graph_from_data_frame(directed = FALSE) %>% 
#   ggraph() + 
#   geom_edge_fan(spread = 5) + 
#   geom_node_point() + 
#   geom_node_text(aes(label = name, #alpha = (name %in% important_labels)), 
#                  repel = TRUE, segment.size = 1, 
#                  segment.color = "pink", color = "blue")) + 
#   theme_void() + 
#   theme(legend.position="none")
```


